<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dev.rogueai.collection.db.sql.ICiuskySearchSql">

    <select id="search" resultMap="ciuskySearchEntity">
        SELECT
            c.ID,
            c.TITLE,
            c.DESCRIPTION,
            t.ID AS TYPE_ID,
            t.DESCR AS TYPE_DESCRIPTION,
            c.QUALITY,
            c.PURCHASE_PLACE,
            c.PURCHASE_DATE,
            c.PAID_PRICE,
            c.MARKET_PRICE,
            c.NOTES
        FROM
            CIUSKY c
            INNER JOIN TYPE_OPTION t ON t.ID = c.TYPE_OPTION
        WHERE 1 = 1
        <if test="text != null">
            AND (
                REGEXP_LIKE(c.TITLE, #{text}, 'i') OR REGEXP_LIKE(c.DESCRIPTION, #{text}, 'i')
            )
        </if>
        <if test="(types != null and !types.isEmpty())">
            <foreach item="type" collection="types" open="AND t.ID in (" separator="," close=")" nullable="false">
                #{type}
            </foreach>
        </if>
        <if test="(tags != null and !tags.isEmpty())">
            <foreach item="tag" collection="tags" nullable="false">
                <if test="tag.key != null and tag.value == null">
                    AND EXISTS (
                        SELECT 1
                        FROM CIUSKY_TAG ct
                        WHERE ct.ID = c.ID
                        AND REGEXP_LIKE(`KEY`, CONCAT('^', #{tag.key}), 'i')
                    )
                </if>
                <if test="tag.key != null and tag.value != null">
                    AND EXISTS (
                        SELECT 1
                        FROM CIUSKY_TAG ct
                        WHERE ct.ID = c.ID
                        AND `KEY` = #{tag.key}
                        AND REGEXP_LIKE(`VALUE`, CONCAT('^', #{tag.value}), 'i')
                    )
                </if>
            </foreach>
        </if>
    </select>

    <select id="selectTags" resultType="dev.rogueai.collection.db.dto.TagEntity">
        SELECT `KEY`, `VALUE` FROM CIUSKY_TAG WHERE ID = #{id}
    </select>

    <select id="selectImages" resultType="java.lang.String">
        SELECT `UUID` FROM CIUSKY_IMG WHERE ID = #{id}
    </select>

    <resultMap id="ciuskySearchEntity" type="dev.rogueai.collection.db.dto.CiuskySearchEntity">
        <id property="id" column="ID" />
        <collection property="tags" javaType="ArrayList" column="ID" select="selectTags"/>
        <collection property="uuidImages" javaType="ArrayList" column="ID" select="selectImages"/>
    </resultMap>

</mapper>
